<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Potree Viewer</title>

  <link rel="stylesheet" href="./libs/potree/potree.css" />
  <link rel="stylesheet" href="./libs/jquery-ui/jquery-ui.min.css" />
  <link rel="stylesheet" href="./libs/openlayers3/ol.css" />
  <link rel="stylesheet" href="./libs/spectrum/spectrum.css" />
  <link rel="stylesheet" href="./libs/jstree/themes/mixed/style.css" />

  <style>
    /* Dark fallback so thereâ€™s no tiled image before Potree starts */
    #potree_render_area { background:#1b1f24; }

    /* Branded header (keeps accordion layout intact) */
    #brandHeader { padding:10px 12px; background:#2b2f36; border-bottom:1px solid #3a3f47; }
    #brandHeader img { display:block; width:100%; max-height:56px; object-fit:contain; }
  </style>
</head>

<body>
  <div class="potree_container" style="position:absolute; inset:0;">
    <div id="potree_render_area"></div>
    <div id="potree_sidebar_container"></div>
  </div>

  <!-- libs -->
  <script src="./libs/jquery/jquery-3.1.1.min.js"></script>
  <script src="./libs/spectrum/spectrum.js"></script>
  <script src="./libs/jquery-ui/jquery-ui.min.js"></script>
  <script src="./libs/three.js/build/three.min.js"></script>
  <script src="./libs/three.js/extra/lines.js"></script>
  <script src="./libs/other/BinaryHeap.js"></script>
  <script src="./libs/tween/tween.min.js"></script>
  <script src="./libs/d3/d3.js"></script>
  <script src="./libs/proj4/proj4.js"></script>
  <script src="./libs/openlayers3/ol.js"></script>
  <script src="./libs/i18next/i18next.js"></script>
  <script src="./libs/jstree/jstree.js"></script>
  <script src="./libs/potree/potree.js"></script>
  <script src="./libs/plasio/js/laslaz.js"></script>

  <script>
    // Clean start each load
    try { localStorage.clear(); sessionStorage.clear(); } catch(e){}

    // Viewer
    window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
    document.title = "Potree Viewer";
    viewer.setBackground("gradient");
    viewer.setEDLEnabled(false);
    viewer.setFOV(60);
    viewer.setPointBudget(8_000_000);

    // --- Force 0.001 m precision everywhere (API + formatters + canvas text) ---
    try {
      viewer.lengthUnit = "m";
      viewer.lengthDecimals = 3;
      if (typeof viewer.setLengthUnit === "function") viewer.setLengthUnit("m");
      if (typeof viewer.setLengthDecimals === "function") viewer.setLengthDecimals(3);
    } catch(e) {}

    (function(){
      const fmt = (m)=> (Number(m)).toFixed(3) + " m";
      try {
        if (Potree && Potree.Utils) {
          Potree.Utils.formatLength = fmt;
          Potree.Utils.toStringLength = fmt;
        }
        if (Potree && Potree.utils) {
          Potree.utils.formatLength = fmt;
          Potree.utils.toStringLength = fmt;
        }
      } catch(e){}
    })();

    (function(){
      const re = /(-?\d+(?:\.\d+)?)(\s*m)\b/;
      const orig = CanvasRenderingContext2D.prototype.fillText;
      if (!CanvasRenderingContext2D.prototype.__potree3decimals) {
        CanvasRenderingContext2D.prototype.fillText = function(text, x, y, maxWidth){
          try {
            if (typeof text === "string") {
              const m = text.match(re);
              if (m) {
                const v = Number(m[1]);
                if (!Number.isNaN(v)) text = text.replace(m[0], v.toFixed(3) + m[2]);
              }
            }
          } catch(e) {}
          return orig.call(this, text, x, y, maxWidth);
        };
        CanvasRenderingContext2D.prototype.__potree3decimals = true;
      }
    })();
    // ---------------------------------------------------------------------------

    // Don't restore saved state
    // viewer.loadSettingsFromURL();

    viewer.loadGUI(() => {
      viewer.setLanguage("en");
      viewer.toggleSidebar();

      const $side = $("#potree_sidebar_container");

      // LOGO header (local file beside sheridan.html) with cache-buster
      (function injectBrandHeader(){
        const logoURL = "./EnableLogo.png?v=" + Date.now();
        const html = '<div id="brandHeader"><img src="'+logoURL+'" alt="Logo"></div>';
        const $hdrAnchor = $side.find("a[href*='potree.org'], a[href*='github'], a[href*='twitter']").first();
        const $hdrRow    = $hdrAnchor.length ? $hdrAnchor.closest("div") : null;
        if ($hdrRow && $hdrRow.length) { $hdrRow.html(html); } else { $side.prepend(html); }
      })();

      // Show only Tools & Navigation; hide everything else
      const hideMenu = sel => { const $m=$(sel); if($m.length){$m.hide();$m.next().hide();} };
      const showMenu = sel => { const $m=$(sel); if($m.length){$m.show();$m.next().show();} };

      hideMenu("#menu_scene");
      hideMenu("#menu_appearance");
      hideMenu("#menu_edl");
      hideMenu("#menu_background");
      hideMenu("#menu_filters");
      hideMenu("#menu_about");
      hideMenu("#menu_other");

      showMenu("#menu_tools");
      showMenu("#menu_navigation");

      // Inside Tools: remove the Clipping block (keep Measurement)
      const $toolsContent = $("#menu_tools").next();
      if ($toolsContent.length){
        $toolsContent.find("*").filter(function(){
          return $(this).text().trim().toLowerCase()==="clipping";
        }).each(function(){
          const $section = $(this).closest("section, fieldset, div");
          if ($section.length) $section.hide();
          $toolsContent.find("*:contains('Clip Task'), *:contains('Clip Method')").each(function(){
            $(this).closest("section, fieldset, div").hide();
          });
        });
      }

      // Force the Tools accordion OPEN on load
      setTimeout(() => {
        const $hdr = $("#menu_tools");
        const $cnt = $hdr.next();
        $hdr.removeClass("ui-accordion-header-collapsed")
            .addClass("ui-accordion-header-active")
            .attr("aria-expanded","true");
        $cnt.addClass("ui-accordion-content-active")
            .attr("aria-hidden","false")
            .show();
      }, 0);
    });

    // Load cloud.js; build enclosing clip box
    Potree.loadPointCloud("pointclouds/sheridan/cloud.js", "sheridan", (e) => {
      const pc = e.pointcloud;
      viewer.scene.addPointCloud(pc);

      const mat = pc.material;
      mat.activeAttributeName = "rgba";
      mat.pointSizeType = Potree.PointSizeType.FIXED;
      mat.shape = Potree.PointShape.CIRCLE;
      mat.size = 1.0;

      // World bounds -> centered clip box that encloses all data
      viewer.scene.scene.updateMatrixWorld(true);
      pc.updateMatrixWorld(true);

      const bbWorld = pc.boundingBox.clone().applyMatrix4(pc.matrixWorld);
      const size = new THREE.Vector3(), center = new THREE.Vector3();
      bbWorld.getSize(size); bbWorld.getCenter(center);

      const margin = 1.03;
      const sx = Math.max(size.x * margin, 0.25);
      const sy = Math.max(size.y * margin, 0.25);
      const sz = Math.max(size.z * margin, 0.25);

      const box = new Potree.BoxVolume();
      box.clip = true;
      box.visible = true;  // show outline so users can grab handles
      if (box.rotation) box.rotation.set(0,0,0);
      box.position.copy(center);
      box.scale.set(sx, sy, sz);
      viewer.scene.addVolume(box);

      // Save reference globally
      window.__clipBox = box;

      // Enable clipping
      viewer.setClipMethod(Potree.ClipMethod.INSIDE_ANY);
      viewer.setClipTask(Potree.ClipTask.SHOW_INSIDE);

      // ---- LOCK THE BOX FROM DELETION ----
      const scene = viewer.scene;
      const origRemoveVolume = scene.removeVolume ? scene.removeVolume.bind(scene) : null;
      if (origRemoveVolume){
        scene.removeVolume = function(v){
          if (v === box) { console.warn("Locked clip box: deletion prevented."); return; }
          return origRemoveVolume(v);
        };
      }
      if (typeof scene.removeAllVolumes === "function"){
        const origRemoveAll = scene.removeAllVolumes.bind(scene);
        scene.removeAllVolumes = function(){
          const vols = scene.volumes.slice();
          vols.forEach(v => { if (v !== box && origRemoveVolume) origRemoveVolume(v); });
        };
      }
      // Watchdog: if anything still removes it, re-add and restore clipping
      setInterval(() => {
        if (scene.volumes.indexOf(box) === -1){
          scene.addVolume(box);
          viewer.setClipTask(Potree.ClipTask.SHOW_INSIDE);
        }
      }, 500);
      // ------------------------------------

      viewer.fitToScreen();
      viewer.repaint();
    });

    // Hotkey "B" to hide/show the box during orthographic measuring
    document.addEventListener("keydown", (ev)=>{
      if (ev.key.toLowerCase() !== "b") return;
      const box = window.__clipBox;
      if (!box || !viewer || !viewer.setClipTask) return;
      if (box.visible){
        box.visible = false;
        viewer.setClipTask(Potree.ClipTask.NONE);
      } else {
        box.visible = true;
        viewer.setClipTask(Potree.ClipTask.SHOW_INSIDE);
      }
      viewer.repaint();
    });
  </script>
</body>
</html>
